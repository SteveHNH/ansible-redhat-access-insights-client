---

- name: Install Red Hat Insights Client
  yum: 
    name: {{ item }} 
    state: present
  with_items:
    - insights-client 

- name: Configure Red Hat Insights Client
  template:
    src: insights-client.conf.j2
    dest: /etc/insights-client/insights-client.conf

- stat: 
    path: /etc/insights-client/.unregistered
  register: unreg

# Only register if this system hasn't been registered before
- name: Register to the Red Hat Insights Service
  command: insights-client --register creates=/etc/insights-client/.registered
  when: unreg.stat.exists == false
